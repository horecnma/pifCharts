<!doctype html>
<html>

<head>
    <title>Line Chart</title>
    <script src="dygraph/dygraph.js"></script>
    <script src="jquery/jquery-2.2.4.js"></script>
    <link rel="stylesheet" href="dygraph/dygraph.css"/>
    <script charset="utf8" src="data_json.js"></script>
    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

        .dygraph-legend {
            left: 70px !important;
            width: 800px;
            background-color: rgba(256, 256, 256, 0.0);
        }
    </style>
</head>

<body>
<div id="status" style="width:700px; font-size:0.8em; padding-top:5px;"></div>
<div id="graph" style="margin-right: 50px; width: 90%; height: 800px;"></div>

<br>
<br>
<script>

    let prepareDygraphData = function () {
        var allTimes = data.flatMap((it) => it.data.map((it2) => it2[0]));
        console.debug(allTimes.length);
        allTimes = Array.from(new Set(allTimes)).sort();
        console.debug(allTimes.length);
        console.debug("");
        for (let i = 0; i < allTimes.length; i++) {
            console.debug(allTimes[i]);
        }

        var result = [];
        // todo insert null values in the begin
        for (let allTimesIndex = 0; allTimesIndex < allTimes.length; allTimesIndex++) {
            let row = [new Date(allTimes[allTimesIndex])];
            for (let seriesIndex = 0; seriesIndex < data.length; seriesIndex++) {
                var series = data[seriesIndex];
                var index = allTimesIndex;
                var k = allTimesIndex;
                while (k < series.data.length && allTimes[allTimesIndex] < series.data[k][0]) {
                    k++;
                }
                if (k >= series.data.length) {
                    row.push(null);
                } else {
                    row.push(series.data[k][1]);
                }
            }
            result.push(row);
        }

        var seriesConf = {};
        for (let i = 0; i < data.length; i++) {
            let d = data[i];
            let name = d.name;
            let color = d.color;
            seriesConf[name] = {
                color: color,    //Accepts CSS colour values.
            }
        }
        return {
            columns: ["time"].concat(data.map((it)=>it.name)),
            seriesProps: seriesConf,
            data: result
        };
    };
    var result = prepareDygraphData();

    $(document).ready(function () {
            new Dygraph(
                document.getElementById('graph'),
                result.data,
                {
                    // customBars: true,
                    // labelsDiv: document.getElementById('status'),
                    title: 'pifs',
                    legend: 'always',
                    showRangeSelector: true,
                    delimiter: ",",

                    labelsSeparateLines: true,
                    highlightSeriesBackgroundAlpha: 0.9,
                    strokeWidth: 1.4,

                    highlightSeriesOpts: {
                        strokeWidth: 3,
                        strokeBorderWidth: 1,
                        highlightCircleSize: 5
                    },
                    labels: result.columns,

                    series: result.seriesProps,

                    xValueParser: function (x) {
                        let number = parseInt(x);
                        console.debug("number");
                        return number;
                    },
                    axis: {
                        x: {
                            valueFormatter: Dygraph.dateString_,
                            ticker: Dygraph.dateTicker
                        },
                        y2: {}
                    },

                    ylabel: 'Primary y-axis',
                    y2label: 'Secondary y-axis'
                }
            );
        }
    );

</script>
</body>

</html>
